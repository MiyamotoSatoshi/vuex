// Styles
import '../../stylus/components/_treeview.styl';
// Components
import VTreeviewNode, { VTreeviewNodeProps } from './VTreeviewNode';
// Mixins
import Themeable from '../../mixins/themeable';
import { provide as RegistrableProvide } from '../../mixins/registrable';
// Utils
import { getObjectValueByPath, deepEqual } from '../../util/helpers';
import mixins from '../../util/mixins';
import { consoleWarn } from '../../util/console';
function ston(s) {
    const n = Number(s);
    return !isNaN(n) ? n : s;
}
export default mixins(RegistrableProvide('treeview'), Themeable
/* @vue/component */
).extend({
    name: 'v-treeview',
    provide() {
        return { treeview: this };
    },
    props: {
        active: {
            type: Array,
            default: () => ([])
        },
        items: {
            type: Array,
            default: () => ([])
        },
        hoverable: Boolean,
        multipleActive: Boolean,
        open: {
            type: Array,
            default: () => ([])
        },
        openAll: Boolean,
        value: {
            type: Array,
            default: () => ([])
        },
        ...VTreeviewNodeProps
    },
    data: () => ({
        nodes: {},
        selectedCache: new Set(),
        activeCache: new Set(),
        openCache: new Set()
    }),
    watch: {
        items: {
            handler() {
                // We only care if nodes are removed or added
                if (Object.keys(this.nodes).length === this.countItems(this.items))
                    return;
                const oldSelectedCache = [...this.selectedCache];
                this.selectedCache = new Set();
                this.activeCache = new Set();
                this.openCache = new Set();
                this.buildTree(this.items);
                // Only emit selected if selection has changed
                // as a result of items changing. This fixes a
                // potential double emit when selecting a node
                // with dynamic children
                if (!deepEqual(oldSelectedCache, [...this.selectedCache]))
                    this.emitSelected();
            },
            deep: true
        },
        active(value) {
            const old = [...this.activeCache];
            if (!value || deepEqual(old, value))
                return;
            old.forEach(key => this.updateActive(key, false));
            value.forEach(key => this.updateActive(key, true));
            this.emitActive();
        },
        value(value) {
            const old = [...this.selectedCache];
            if (!value || deepEqual(old, value))
                return;
            old.forEach(key => this.updateSelected(key, false));
            value.forEach(key => this.updateSelected(key, true));
            this.emitSelected();
        },
        open(value) {
            const old = [...this.openCache];
            if (deepEqual(old, value))
                return;
            old.forEach(key => this.updateOpen(key, false));
            value.forEach(key => this.updateOpen(key, true));
            this.emitOpen();
        }
    },
    created() {
        this.buildTree(this.items);
        this.value.forEach(key => this.updateSelected(key, true));
        this.emitSelected();
        this.active.forEach(key => this.updateActive(key, true));
        this.emitActive();
    },
    mounted() {
        // Save the developer from themselves
        if (this.$slots.prepend || this.$slots.append) {
            consoleWarn('The prepend and append slots require a slot-scope attribute', this);
        }
        if (this.openAll) {
            Object.keys(this.nodes).forEach(key => this.updateOpen(ston(key), true));
        }
        else {
            this.open.forEach(key => this.updateOpen(key, true));
        }
        this.emitOpen();
    },
    methods: {
        buildTree(items, parent = null) {
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const key = getObjectValueByPath(item, this.itemKey);
                const children = getObjectValueByPath(item, this.itemChildren, []);
                const oldNode = this.nodes.hasOwnProperty(key) ? this.nodes[key] : {
                    isSelected: false, isIndeterminate: false, isActive: false, isOpen: false, vnode: null
                };
                const node = {
                    vnode: oldNode.vnode,
                    parent,
                    children: children.map((c) => getObjectValueByPath(c, this.itemKey))
                };
                this.buildTree(children, key);
                // This fixed bug with dynamic children resetting selected parent state
                if (!this.nodes.hasOwnProperty(key) && parent !== null && this.nodes.hasOwnProperty(parent)) {
                    node.isSelected = this.nodes[parent].isSelected;
                    node.isIndeterminate = this.nodes[parent].isIndeterminate;
                }
                else {
                    node.isSelected = oldNode.isSelected;
                    node.isIndeterminate = oldNode.isIndeterminate;
                }
                node.isActive = oldNode.isActive;
                node.isOpen = oldNode.isOpen;
                this.nodes[key] = !children.length ? node : this.calculateState(node, this.nodes);
                // Don't forget to rebuild cache
                if (this.nodes[key].isSelected)
                    this.selectedCache.add(key);
                if (this.nodes[key].isActive)
                    this.activeCache.add(key);
                if (this.nodes[key].isOpen)
                    this.openCache.add(key);
                this.updateVnodeState(key);
            }
        },
        countItems(items) {
            let count = 0;
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                count += 1;
                count += item.children ? this.countItems(item.children) : 0;
            }
            return count;
        },
        calculateState(node, state) {
            const counts = node.children.reduce((counts, child) => {
                counts[0] += +Boolean(state[child].isSelected);
                counts[1] += +Boolean(state[child].isIndeterminate);
                return counts;
            }, [0, 0]);
            node.isSelected = !!node.children.length && counts[0] === node.children.length;
            node.isIndeterminate = !node.isSelected && (counts[0] > 0 || counts[1] > 0);
            return node;
        },
        emitOpen() {
            this.$emit('update:open', [...this.openCache]);
        },
        emitSelected() {
            this.$emit('input', [...this.selectedCache]);
        },
        emitActive() {
            this.$emit('update:active', [...this.activeCache]);
        },
        getDescendants(key, descendants = []) {
            const children = this.nodes[key].children;
            descendants.push(...children);
            for (let i = 0; i < children.length; i++) {
                descendants = this.getDescendants(children[i], descendants);
            }
            return descendants;
        },
        getParents(key) {
            let parent = this.nodes[key].parent;
            const parents = [];
            while (parent !== null) {
                parents.push(parent);
                parent = this.nodes[parent].parent;
            }
            return parents;
        },
        register(node) {
            const key = getObjectValueByPath(node.item, this.itemKey);
            this.nodes[key].vnode = node;
            this.updateVnodeState(key);
        },
        unregister(node) {
            const key = getObjectValueByPath(node.item, this.itemKey);
            this.nodes[key].vnode = null;
        },
        updateActive(key, isActive) {
            if (!this.nodes.hasOwnProperty(key))
                return;
            if (!this.multipleActive) {
                this.activeCache.forEach(active => {
                    this.nodes[active].isActive = false;
                    this.updateVnodeState(active);
                    this.activeCache.delete(active);
                });
            }
            const node = this.nodes[key];
            if (!node)
                return;
            if (isActive)
                this.activeCache.add(key);
            else
                this.activeCache.delete(key);
            node.isActive = isActive;
            this.updateVnodeState(key);
        },
        updateSelected(key, isSelected) {
            if (!this.nodes.hasOwnProperty(key))
                return;
            const changed = {};
            const descendants = [key, ...this.getDescendants(key)];
            descendants.forEach(descendant => {
                this.nodes[descendant].isSelected = isSelected;
                this.nodes[descendant].isIndeterminate = false;
                changed[descendant] = isSelected;
            });
            const parents = this.getParents(key);
            parents.forEach(parent => {
                this.nodes[parent] = this.calculateState(this.nodes[parent], this.nodes);
                changed[parent] = this.nodes[parent].isSelected;
            });
            const all = [key, ...descendants, ...parents];
            all.forEach(this.updateVnodeState);
            Object.keys(changed).forEach(k => {
                changed[k] === true ? this.selectedCache.add(ston(k)) : this.selectedCache.delete(ston(k));
            });
        },
        updateOpen(key, isOpen) {
            if (!this.nodes.hasOwnProperty(key))
                return;
            const node = this.nodes[key];
            if (node.children && !node.children.length && node.vnode && !node.vnode.hasLoaded) {
                node.vnode.checkChildren().then(() => this.updateOpen(key, isOpen));
            }
            else {
                node.isOpen = isOpen;
                node.isOpen ? this.openCache.add(key) : this.openCache.delete(key);
                this.updateVnodeState(key);
            }
        },
        updateVnodeState(key) {
            const node = this.nodes[key];
            if (node && node.vnode) {
                node.vnode.isSelected = node.isSelected;
                node.vnode.isIndeterminate = node.isIndeterminate;
                node.vnode.isActive = node.isActive;
                node.vnode.isOpen = node.isOpen;
            }
        }
    },
    render(h) {
        const children = this.items.length
            ? this.items.map(VTreeviewNode.options.methods.genChild.bind(this))
            /* istanbul ignore next */
            : this.$slots.default;
        return h('div', {
            staticClass: 'v-treeview',
            class: {
                'v-treeview--hoverable': this.hoverable,
                ...this.themeClasses
            }
        }, children);
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVlRyZWV2aWV3LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbXBvbmVudHMvVlRyZWV2aWV3L1ZUcmVldmlldy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxTQUFTO0FBQ1QsT0FBTyx3Q0FBd0MsQ0FBQTtBQU0vQyxhQUFhO0FBQ2IsT0FBTyxhQUFhLEVBQUUsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGlCQUFpQixDQUFBO0FBRW5FLFNBQVM7QUFDVCxPQUFPLFNBQVMsTUFBTSx3QkFBd0IsQ0FBQTtBQUM5QyxPQUFPLEVBQUUsT0FBTyxJQUFJLGtCQUFrQixFQUFFLE1BQU0sMEJBQTBCLENBQUE7QUFFeEUsUUFBUTtBQUNSLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxTQUFTLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQTtBQUNwRSxPQUFPLE1BQU0sTUFBTSxtQkFBbUIsQ0FBQTtBQUN0QyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sb0JBQW9CLENBQUE7QUFpQmhELFNBQVMsSUFBSSxDQUFFLENBQWtCO0lBQy9CLE1BQU0sQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUNuQixPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtBQUMxQixDQUFDO0FBRUQsZUFBZSxNQUFNLENBQ25CLGtCQUFrQixDQUFDLFVBQVUsQ0FBQyxFQUM5QixTQUFTO0FBQ1Qsb0JBQW9CO0NBQ3JCLENBQUMsTUFBTSxDQUFDO0lBQ1AsSUFBSSxFQUFFLFlBQVk7SUFFbEIsT0FBTztRQUNMLE9BQU8sRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLENBQUE7SUFDM0IsQ0FBQztJQUVELEtBQUssRUFBRTtRQUNMLE1BQU0sRUFBRTtZQUNOLElBQUksRUFBRSxLQUFLO1lBQ1gsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFD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Q0FBQTtnQkFDakQsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQTtnQkFDbkMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQTthQUNoQztRQUNILENBQUM7S0FDRjtJQUVELE1BQU0sQ0FBRSxDQUFDO1FBQ1AsTUFBTSxRQUFRLEdBQStCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTTtZQUM1RCxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNuRSwwQkFBMEI7WUFDMUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFBO1FBRXZCLE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRTtZQUNkLFdBQVcsRUFBRSxZQUFZO1lBQ3pCLEtBQUssRUFBRTtnQkFDTCx1QkFBdUIsRUFBRSxJQUFJLENBQUMsU0FBUztnQkFDdkMsR0FBRyxJQUFJLENBQUMsWUFBWTthQUNyQjtTQUNGLEVBQUUsUUFBUSxDQUFDLENBQUE7SUFDZCxDQUFDO0NBQ0YsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLy8gU3R5bGVzXG5pbXBvcnQgJy4uLy4uL3N0eWx1cy9jb21wb25lbnRzL190cmVldmlldy5zdHlsJ1xuXG4vLyBUeXBlc1xuaW1wb3J0IHsgVk5vZGUsIFZOb2RlQ2hpbGRyZW5BcnJheUNvbnRlbnRzIH0gZnJvbSAndnVlJ1xuaW1wb3J0IHsgUHJvcFZhbGlkYXRvciB9IGZyb20gJy4uLy4uLy4uL25vZGVfbW9kdWxlcy92dWUvdHlwZXMvb3B0aW9ucydcblxuLy8gQ29tcG9uZW50c1xuaW1wb3J0IFZUcmVldmlld05vZGUsIHsgVlRyZWV2aWV3Tm9kZVByb3BzIH0gZnJvbSAnLi9WVHJlZXZpZXdOb2RlJ1xuXG4vLyBNaXhpbnNcbmltcG9ydCBUaGVtZWFibGUgZnJvbSAnLi4vLi4vbWl4aW5zL3RoZW1lYWJsZSdcbmltcG9ydCB7IHByb3ZpZGUgYXMgUmVnaXN0cmFibGVQcm92aWRlIH0gZnJvbSAnLi4vLi4vbWl4aW5zL3JlZ2lzdHJhYmxlJ1xuXG4vLyBVdGlsc1xuaW1wb3J0IHsgZ2V0T2JqZWN0VmFsdWVCeVBhdGgsIGRlZXBFcXVhbCB9IGZyb20gJy4uLy4uL3V0aWwvaGVscGVycydcbmltcG9ydCBtaXhpbnMgZnJvbSAnLi4vLi4vdXRpbC9taXhpbnMnXG5pbXBvcnQgeyBjb25zb2xlV2FybiB9IGZyb20gJy4uLy4uL3V0aWwvY29uc29sZSdcblxudHlwZSBWVHJlZXZpZXdOb2RlSW5zdGFuY2UgPSBJbnN0YW5jZVR5cGU8dHlwZW9mIFZUcmVldmlld05vZGU+XG5cbnR5cGUgTm9kZUNhY2hlID0gU2V0PHN0cmluZyB8IG51bWJlcj5cbnR5cGUgTm9kZUFycmF5ID0gKHN0cmluZyB8IG51bWJlcilbXVxuXG50eXBlIE5vZGVTdGF0ZSA9IHtcbiAgcGFyZW50OiBudW1iZXIgfCBzdHJpbmcgfCBudWxsXG4gIGNoaWxkcmVuOiAobnVtYmVyIHwgc3RyaW5nKVtdXG4gIHZub2RlOiBWVHJlZXZpZXdOb2RlSW5zdGFuY2UgfCBudWxsXG4gIGlzQWN0aXZlOiBib29sZWFuXG4gIGlzU2VsZWN0ZWQ6IGJvb2xlYW5cbiAgaXNJbmRldGVybWluYXRlOiBib29sZWFuXG4gIGlzT3BlbjogYm9vbGVhblxufVxuXG5mdW5jdGlvbiBzdG9uIChzOiBzdHJpbmcgfCBudW1iZXIpIHtcbiAgY29uc3QgbiA9IE51bWJlcihzKVxuICByZXR1cm4gIWlzTmFOKG4pID8gbiA6IHNcbn1cblxuZXhwb3J0IGRlZmF1bHQgbWl4aW5zKFxuICBSZWdpc3RyYWJsZVByb3ZpZGUoJ3RyZWV2aWV3JyksXG4gIFRoZW1lYWJsZVxuICAvKiBAdnVlL2NvbXBvbmVudCAqL1xuKS5leHRlbmQoe1xuICBuYW1lOiAndi10cmVldmlldycsXG5cbiAgcHJvdmlkZSAoKTogb2JqZWN0IHtcbiAgICByZXR1cm4geyB0cmVldmlldzogdGhpcyB9XG4gIH0sXG5cbiAgcHJvcHM6IHtcbiAgICBhY3RpdmU6IHtcbiAgICAgIHR5cGU6IEFycmF5LFxuICAgICAgZGVmYXVsdDogKCkgPT4gKFtdKVxuICAgIH0gYXMgUHJvcFZhbGlkYXRvcjxOb2RlQXJyYXk+LFxuICAgIGl0ZW1zOiB7XG4gICAgICB0eXBlOiBBcnJheSxcbiAgICAgIGRlZmF1bHQ6ICgpID0+IChbXSlcbiAgICB9IGFzIFByb3BWYWxpZGF0b3I8YW55W10+LFxuICAgIGhvdmVyYWJsZTogQm9vbGVhbixcbiAgICBtdWx0aXBsZUFjdGl2ZTogQm9vbGVhbixcbiAgICBvcGVuOiB7XG4gICAgICB0eXBlOiBBcnJheSxcbiAgICAgIGRlZmF1bHQ6ICgpID0+IChbXSlcbiAgICB9IGFzIFByb3BWYWxpZGF0b3I8Tm9kZUFycmF5PixcbiAgICBvcGVuQWxsOiBCb29sZWFuLFxuICAgIHZhbHVlOiB7XG4gICAgICB0eXBlOiBBcnJheSxcbiAgICAgIGRlZmF1bHQ6ICgpID0+IChbXSlcbiAgICB9IGFzIFByb3BWYWxpZGF0b3I8Tm9kZUFycmF5PixcbiAgICAuLi5WVHJlZXZpZXdOb2RlUHJvcHNcbiAgfSxcblxuICBkYXRhOiAoKSA9PiAoe1xuICAgIG5vZGVzOiB7fSBhcyBSZWNvcmQ8c3RyaW5nIHwgbnVtYmVyLCBOb2RlU3RhdGU+LFxuICAgIHNlbGVjdGVkQ2FjaGU6IG5ldyBTZXQoKSBhcyBOb2RlQ2FjaGUsXG4gICAgYWN0aXZlQ2FjaGU6IG5ldyBTZXQoKSBhcyBOb2RlQ2FjaGUsXG4gICAgb3BlbkNhY2hlOiBuZXcgU2V0KCkgYXMgTm9kZUNhY2hlXG4gIH0pLFxuXG4gIHdhdGNoOiB7XG4gICAgaXRlbXM6IHtcbiAgICAgIGhhbmRsZXIgKCkge1xuICAgICAgICAvLyBXZSBvbmx5IGNhcmUgaWYgbm9kZXMgYXJlIHJlbW92ZWQgb3IgYWRkZWRcbiAgICAgICAgaWYgKE9iamVjdC5rZXlzKHRoaXMubm9kZXMpLmxlbmd0aCA9PT0gdGhpcy5jb3VudEl0ZW1zKHRoaXMuaXRlbXMpKSByZXR1cm5cblxuICAgICAgICBjb25zdCBvbGRTZWxlY3RlZENhY2hlID0gWy4uLnRoaXMuc2VsZWN0ZWRDYWNoZV1cbiAgICAgICAgdGhpcy5zZWxlY3RlZENhY2hlID0gbmV3IFNldCgpXG4gICAgICAgIHRoaXMuYWN0aXZlQ2FjaGUgPSBuZXcgU2V0KClcbiAgICAgICAgdGhpcy5vcGVuQ2FjaGUgPSBuZXcgU2V0KClcbiAgICAgICAgdGhpcy5idWlsZFRyZWUodGhpcy5pdGVtcylcblxuICAgICAgICAvLyBPbmx5IGVtaXQgc2VsZWN0ZWQgaWYgc2VsZWN0aW9uIGhhcyBjaGFuZ2VkXG4gICAgICAgIC8vIGFzIGEgcmVzdWx0IG9mIGl0ZW1zIGNoYW5naW5nLiBUaGlzIGZpeGVzIGFcbiAgICAgICAgLy8gcG90ZW50aWFsIGRvdWJsZSBlbWl0IHdoZW4gc2VsZWN0aW5nIGEgbm9kZVxuICAgICAgICAvLyB3aXRoIGR5bmFtaWMgY2hpbGRyZW5cbiAgICAgICAgaWYgKCFkZWVwRXF1YWwob2xkU2VsZWN0ZWRDYWNoZSwgWy4uLnRoaXMuc2VsZWN0ZWRDYWNoZV0pKSB0aGlzLmVtaXRTZWxlY3RlZCgpXG4gICAgICB9LFxuICAgICAgZGVlcDogdHJ1ZVxuICAgIH0sXG4gICAgYWN0aXZlICh2YWx1ZTogKHN0cmluZyB8IG51bWJlcilbXSkge1xuICAgICAgY29uc3Qgb2xkID0gWy4uLnRoaXMuYWN0aXZlQ2FjaGVdXG4gICAgICBpZiAoIXZhbHVlIHx8IGRlZXBFcXVhbChvbGQsIHZhbHVlKSkgcmV0dXJuXG5cbiAgICAgIG9sZC5mb3JFYWNoKGtleSA9PiB0aGlzLnVwZGF0ZUFjdGl2ZShrZXksIGZhbHNlKSlcbiAgICAgIHZhbHVlLmZvckVhY2goa2V5ID0+IHRoaXMudXBkYXRlQWN0aXZlKGtleSwgdHJ1ZSkpXG4gICAgICB0aGlzLmVtaXRBY3RpdmUoKVxuICAgIH0sXG4gICAgdmFsdWUgKHZhbHVlOiAoc3RyaW5nIHwgbnVtYmVyKVtdKSB7XG4gICAgICBjb25zdCBvbGQgPSBbLi4udGhpcy5zZWxlY3RlZENhY2hlXVxuICAgICAgaWYgKCF2YWx1ZSB8fCBkZWVwRXF1YWwob2xkLCB2YWx1ZSkpIHJldHVyblxuXG4gICAgICBvbGQuZm9yRWFjaChrZXkgPT4gdGhpcy51cGRhdGVTZWxlY3RlZChrZXksIGZhbHNlKSlcbiAgICAgIHZhbHVlLmZvckVhY2goa2V5ID0+IHRoaXMudXBkYXRlU2VsZWN0ZWQoa2V5LCB0cnVlKSlcbiAgICAgIHRoaXMuZW1pdFNlbGVjdGVkKClcbiAgICB9LFxuICAgIG9wZW4gKHZhbHVlOiAoc3RyaW5nIHwgbnVtYmVyKVtdKSB7XG4gICAgICBjb25zdCBvbGQgPSBbLi4udGhpcy5vcGVuQ2FjaGVdXG4gICAgICBpZiAoZGVlcEVxdWFsKG9sZCwgdmFsdWUpKSByZXR1cm5cblxuICAgICAgb2xkLmZvckVhY2goa2V5ID0+IHRoaXMudXBkYXRlT3BlbihrZXksIGZhbHNlKSlcbiAgICAgIHZhbHVlLmZvckVhY2goa2V5ID0+IHRoaXMudXBkYXRlT3BlbihrZXksIHRydWUpKVxuICAgICAgdGhpcy5lbWl0T3BlbigpXG4gICAgfVxuICB9LFxuXG4gIGNyZWF0ZWQgKCkge1xuICAgIHRoaXMuYnVpbGRUcmVlKHRoaXMuaXRlbXMpXG4gICAgdGhpcy52YWx1ZS5mb3JFYWNoKGtleSA9PiB0aGlzLnVwZGF0ZVNlbGVjdGVkKGtleSwgdHJ1ZSkpXG4gICAgdGhpcy5lbWl0U2VsZWN0ZWQoKVxuICAgIHRoaXMuYWN0aXZlLmZvckVhY2goa2V5ID0+IHRoaXMudXBkYXRlQWN0aXZlKGtleSwgdHJ1ZSkpXG4gICAgdGhpcy5lbWl0QWN0aXZlKClcbiAgfSxcblxuICBtb3VudGVkICgpIHtcbiAgICAvLyBTYXZlIHRoZSBkZXZlbG9wZXIgZnJvbSB0aGVtc2VsdmVzXG4gICAgaWYgKHRoaXMuJHNsb3RzLnByZXBlbmQgfHwgdGhpcy4kc2xvdHMuYXBwZW5kKSB7XG4gICAgICBjb25zb2xlV2FybignVGhlIHByZXBlbmQgYW5kIGFwcGVuZCBzbG90cyByZXF1aXJlIGEgc2xvdC1zY29wZSBhdHRyaWJ1dGUnLCB0aGlzKVxuICAgIH1cblxuICAgIGlmICh0aGlzLm9wZW5BbGwpIHtcbiAgICAgIE9iamVjdC5rZXlzKHRoaXMubm9kZXMpLmZvckVhY2goa2V5ID0+IHRoaXMudXBkYXRlT3BlbihzdG9uKGtleSksIHRydWUpKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLm9wZW4uZm9yRWFjaChrZXkgPT4gdGhpcy51cGRhdGVPcGVuKGtleSwgdHJ1ZSkpXG4gICAgfVxuXG4gICAgdGhpcy5lbWl0T3BlbigpXG4gIH0sXG5cbiAgbWV0aG9kczoge1xuICAgIGJ1aWxkVHJlZSAoaXRlbXM6IGFueVtdLCBwYXJlbnQ6IChzdHJpbmcgfCBudW1iZXIgfCBudWxsKSA9IG51bGwpIHtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3QgaXRlbSA9IGl0ZW1zW2ldXG4gICAgICAgIGNvbnN0IGtleSA9IGdldE9iamVjdFZhbHVlQnlQYXRoKGl0ZW0sIHRoaXMuaXRlbUtleSlcbiAgICAgICAgY29uc3QgY2hpbGRyZW4gPSBnZXRPYmplY3RWYWx1ZUJ5UGF0aChpdGVtLCB0aGlzLml0ZW1DaGlsZHJlbiwgW10pXG4gICAgICAgIGNvbnN0IG9sZE5vZGUgPSB0aGlzLm5vZGVzLmhhc093blByb3BlcnR5KGtleSkgPyB0aGlzLm5vZGVzW2tleV0gOiB7XG4gICAgICAgICAgaXNTZWxlY3RlZDogZmFsc2UsIGlzSW5kZXRlcm1pbmF0ZTogZmFsc2UsIGlzQWN0aXZlOiBmYWxzZSwgaXNPcGVuOiBmYWxzZSwgdm5vZGU6IG51bGxcbiAgICAgICAgfSBhcyBOb2RlU3RhdGVcblxuICAgICAgICBjb25zdCBub2RlOiBhbnkgPSB7XG4gICAgICAgICAgdm5vZGU6IG9sZE5vZGUudm5vZGUsXG4gICAgICAgICAgcGFyZW50LFxuICAgICAgICAgIGNoaWxkcmVuOiBjaGlsZHJlbi5tYXAoKGM6IGFueSkgPT4gZ2V0T2JqZWN0VmFsdWVCeVBhdGgoYywgdGhpcy5pdGVtS2V5KSlcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuYnVpbGRUcmVlKGNoaWxkcmVuLCBrZXkpXG5cbiAgICAgICAgLy8gVGhpcyBmaXhlZCBidWcgd2l0aCBkeW5hbWljIGNoaWxkcmVuIHJlc2V0dGluZyBzZWxlY3RlZCBwYXJlbnQgc3RhdGVcbiAgICAgICAgaWYgKCF0aGlzLm5vZGVzLmhhc093blByb3BlcnR5KGtleSkgJiYgcGFyZW50ICE9PSBudWxsICYmIHRoaXMubm9kZXMuaGFzT3duUHJvcGVydHkocGFyZW50KSkge1xuICAgICAgICAgIG5vZGUuaXNTZWxlY3RlZCA9IHRoaXMubm9kZXNbcGFyZW50XS5pc1NlbGVjdGVkXG4gICAgICAgICAgbm9kZS5pc0luZGV0ZXJtaW5hdGUgPSB0aGlzLm5vZGVzW3BhcmVudF0uaXNJbmRldGVybWluYXRlXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbm9kZS5pc1NlbGVjdGVkID0gb2xkTm9kZS5pc1NlbGVjdGVkXG4gICAgICAgICAgbm9kZS5pc0luZGV0ZXJtaW5hdGUgPSBvbGROb2RlLmlzSW5kZXRlcm1pbmF0ZVxuICAgICAgICB9XG5cbiAgICAgICAgbm9kZS5pc0FjdGl2ZSA9IG9sZE5vZGUuaXNBY3RpdmVcbiAgICAgICAgbm9kZS5pc09wZW4gPSBvbGROb2RlLmlzT3BlblxuXG4gICAgICAgIHRoaXMubm9kZXNba2V5XSA9ICFjaGlsZHJlbi5sZW5ndGggPyBub2RlIDogdGhpcy5jYWxjdWxhdGVTdGF0ZShub2RlLCB0aGlzLm5vZGVzKVxuXG4gICAgICAgIC8vIERvbid0IGZvcmdldCB0byByZWJ1aWxkIGNhY2hlXG4gICAgICAgIGlmICh0aGlzLm5vZGVzW2tleV0uaXNTZWxlY3RlZCkgdGhpcy5zZWxlY3RlZENhY2hlLmFkZChrZXkpXG4gICAgICAgIGlmICh0aGlzLm5vZGVzW2tleV0uaXNBY3RpdmUpIHRoaXMuYWN0aXZlQ2FjaGUuYWRkKGtleSlcbiAgICAgICAgaWYgKHRoaXMubm9kZXNba2V5XS5pc09wZW4pIHRoaXMub3BlbkNhY2hlLmFkZChrZXkpXG5cbiAgICAgICAgdGhpcy51cGRhdGVWbm9kZVN0YXRlKGtleSlcbiAgICAgIH1cbiAgICB9LFxuICAgIGNvdW50SXRlbXMgKGl0ZW1zOiBhbnlbXSkge1xuICAgICAgbGV0IGNvdW50ID0gMFxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBpdGVtID0gaXRlbXNbaV1cbiAgICAgICAgY291bnQgKz0gMVxuICAgICAgICBjb3VudCArPSBpdGVtLmNoaWxkcmVuID8gdGhpcy5jb3VudEl0ZW1zKGl0ZW0uY2hpbGRyZW4pIDogMFxuICAgICAgfVxuXG4gICAgICByZXR1cm4gY291bnRcbiAgICB9LFxuICAgIGNhbGN1bGF0ZVN0YXRlIChub2RlOiBOb2RlU3RhdGUsIHN0YXRlOiBSZWNvcmQ8c3RyaW5nIHwgbnVtYmVyLCBOb2RlU3RhdGU+KSB7XG4gICAgICBjb25zdCBjb3VudHMgPSBub2RlLmNoaWxkcmVuLnJlZHVjZSgoY291bnRzOiBudW1iZXJbXSwgY2hpbGQ6IHN0cmluZyB8IG51bWJlcikgPT4ge1xuICAgICAgICBjb3VudHNbMF0gKz0gK0Jvb2xlYW4oc3RhdGVbY2hpbGRdLmlzU2VsZWN0ZWQpXG4gICAgICAgIGNvdW50c1sxXSArPSArQm9vbGVhbihzdGF0ZVtjaGlsZF0uaXNJbmRldGVybWluYXRlKVxuICAgICAgICByZXR1cm4gY291bnRzXG4gICAgICB9LCBbMCwgMF0pXG5cbiAgICAgIG5vZGUuaXNTZWxlY3RlZCA9ICEhbm9kZS5jaGlsZHJlbi5sZW5ndGggJiYgY291bnRzWzBdID09PSBub2RlLmNoaWxkcmVuLmxlbmd0aFxuICAgICAgbm9kZS5pc0luZGV0ZXJtaW5hdGUgPSAhbm9kZS5pc1NlbGVjdGVkICYmIChjb3VudHNbMF0gPiAwIHx8IGNvdW50c1sxXSA+IDApXG5cbiAgICAgIHJldHVybiBub2RlXG4gICAgfSxcbiAgICBlbWl0T3BlbiAoKSB7XG4gICAgICB0aGlzLiRlbWl0KCd1cGRhdGU6b3BlbicsIFsuLi50aGlzLm9wZW5DYWNoZV0pXG4gICAgfSxcbiAgICBlbWl0U2VsZWN0ZWQgKCkge1xuICAgICAgdGhpcy4kZW1pdCgnaW5wdXQnLCBbLi4udGhpcy5zZWxlY3RlZENhY2hlXSlcbiAgICB9LFxuICAgIGVtaXRBY3RpdmUgKCkge1xuICAgICAgdGhpcy4kZW1pdCgndXBkYXRlOmFjdGl2ZScsIFsuLi50aGlzLmFjdGl2ZUNhY2hlXSlcbiAgICB9LFxuICAgIGdldERlc2NlbmRhbnRzIChrZXk6IHN0cmluZyB8IG51bWJlciwgZGVzY2VuZGFudHM6IE5vZGVBcnJheSA9IFtdKSB7XG4gICAgICBjb25zdCBjaGlsZHJlbiA9IHRoaXMubm9kZXNba2V5XS5jaGlsZHJlblxuXG4gICAgICBkZXNjZW5kYW50cy5wdXNoKC4uLmNoaWxkcmVuKVxuXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGRlc2NlbmRhbnRzID0gdGhpcy5nZXREZXNjZW5kYW50cyhjaGlsZHJlbltpXSwgZGVzY2VuZGFudHMpXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBkZXNjZW5kYW50c1xuICAgIH0sXG4gICAgZ2V0UGFyZW50cyAoa2V5OiBzdHJpbmcgfCBudW1iZXIpIHtcbiAgICAgIGxldCBwYXJlbnQgPSB0aGlzLm5vZGVzW2tleV0ucGFyZW50XG5cbiAgICAgIGNvbnN0IHBhcmVudHMgPSBbXVxuICAgICAgd2hpbGUgKHBhcmVudCAhPT0gbnVsbCkge1xuICAgICAgICBwYXJlbnRzLnB1c2gocGFyZW50KVxuICAgICAgICBwYXJlbnQgPSB0aGlzLm5vZGVzW3BhcmVudF0ucGFyZW50XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBwYXJlbnRzXG4gICAgfSxcbiAgICByZWdpc3RlciAobm9kZTogVlRyZWV2aWV3Tm9kZUluc3RhbmNlKSB7XG4gICAgICBjb25zdCBrZXkgPSBnZXRPYmplY3RWYWx1ZUJ5UGF0aChub2RlLml0ZW0sIHRoaXMuaXRlbUtleSlcbiAgICAgIHRoaXMubm9kZXNba2V5XS52bm9kZSA9IG5vZGVcblxuICAgICAgdGhpcy51cGRhdGVWbm9kZVN0YXRlKGtleSlcbiAgICB9LFxuICAgIHVucmVnaXN0ZXIgKG5vZGU6IFZUcmVldmlld05vZGVJbnN0YW5jZSkge1xuICAgICAgY29uc3Qga2V5ID0gZ2V0T2JqZWN0VmFsdWVCeVBhdGgobm9kZS5pdGVtLCB0aGlzLml0ZW1LZXkpXG4gICAgICB0aGlzLm5vZGVzW2tleV0udm5vZGUgPSBudWxsXG4gICAgfSxcbiAgICB1cGRhdGVBY3RpdmUgKGtleTogc3RyaW5nIHwgbnVtYmVyLCBpc0FjdGl2ZTogYm9vbGVhbikge1xuICAgICAgaWYgKCF0aGlzLm5vZGVzLmhhc093blByb3BlcnR5KGtleSkpIHJldHVyblxuXG4gICAgICBpZiAoIXRoaXMubXVsdGlwbGVBY3RpdmUpIHtcbiAgICAgICAgdGhpcy5hY3RpdmVDYWNoZS5mb3JFYWNoKGFjdGl2ZSA9PiB7XG4gICAgICAgICAgdGhpcy5ub2Rlc1thY3RpdmVdLmlzQWN0aXZlID0gZmFsc2VcbiAgICAgICAgICB0aGlzLnVwZGF0ZVZub2RlU3RhdGUoYWN0aXZlKVxuICAgICAgICAgIHRoaXMuYWN0aXZlQ2FjaGUuZGVsZXRlKGFjdGl2ZSlcbiAgICAgICAgfSlcbiAgICAgIH1cblxuICAgICAgY29uc3Qgbm9kZSA9IHRoaXMubm9kZXNba2V5XVxuICAgICAgaWYgKCFub2RlKSByZXR1cm5cblxuICAgICAgaWYgKGlzQWN0aXZlKSB0aGlzLmFjdGl2ZUNhY2hlLmFkZChrZXkpXG4gICAgICBlbHNlIHRoaXMuYWN0aXZlQ2FjaGUuZGVsZXRlKGtleSlcblxuICAgICAgbm9kZS5pc0FjdGl2ZSA9IGlzQWN0aXZlXG5cbiAgICAgIHRoaXMudXBkYXRlVm5vZGVTdGF0ZShrZXkpXG4gICAgfSxcbiAgICB1cGRhdGVTZWxlY3RlZCAoa2V5OiBzdHJpbmcgfCBudW1iZXIsIGlzU2VsZWN0ZWQ6IGJvb2xlYW4pIHtcbiAgICAgIGlmICghdGhpcy5ub2Rlcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSByZXR1cm5cblxuICAgICAgY29uc3QgY2hhbmdlZDogUmVjb3JkPHN0cmluZyB8IG51bWJlciwgYm9vbGVhbj4gPSB7fVxuXG4gICAgICBjb25zdCBkZXNjZW5kYW50cyA9IFtrZXksIC4uLnRoaXMuZ2V0RGVzY2VuZGFudHMoa2V5KV1cbiAgICAgIGRlc2NlbmRhbnRzLmZvckVhY2goZGVzY2VuZGFudCA9PiB7XG4gICAgICAgIHRoaXMubm9kZXNbZGVzY2VuZGFudF0uaXNTZWxlY3RlZCA9IGlzU2VsZWN0ZWRcbiAgICAgICAgdGhpcy5ub2Rlc1tkZXNjZW5kYW50XS5pc0luZGV0ZXJtaW5hdGUgPSBmYWxzZVxuICAgICAgICBjaGFuZ2VkW2Rlc2NlbmRhbnRdID0gaXNTZWxlY3RlZFxuICAgICAgfSlcblxuICAgICAgY29uc3QgcGFyZW50cyA9IHRoaXMuZ2V0UGFyZW50cyhrZXkpXG4gICAgICBwYXJlbnRzLmZvckVhY2gocGFyZW50ID0+IHtcbiAgICAgICAgdGhpcy5ub2Rlc1twYXJlbnRdID0gdGhpcy5jYWxjdWxhdGVTdGF0ZSh0aGlzLm5vZGVzW3BhcmVudF0sIHRoaXMubm9kZXMpXG4gICAgICAgIGNoYW5nZWRbcGFyZW50XSA9IHRoaXMubm9kZXNbcGFyZW50XS5pc1NlbGVjdGVkXG4gICAgICB9KVxuXG4gICAgICBjb25zdCBhbGwgPSBba2V5LCAuLi5kZXNjZW5kYW50cywgLi4ucGFyZW50c11cbiAgICAgIGFsbC5mb3JFYWNoKHRoaXMudXBkYXRlVm5vZGVTdGF0ZSlcblxuICAgICAgT2JqZWN0LmtleXMoY2hhbmdlZCkuZm9yRWFjaChrID0+IHtcbiAgICAgICAgY2hhbmdlZFtrXSA9PT0gdHJ1ZSA/IHRoaXMuc2VsZWN0ZWRDYWNoZS5hZGQoc3RvbihrKSkgOiB0aGlzLnNlbGVjdGVkQ2FjaGUuZGVsZXRlKHN0b24oaykpXG4gICAgICB9KVxuICAgIH0sXG4gICAgdXBkYXRlT3BlbiAoa2V5OiBzdHJpbmcgfCBudW1iZXIsIGlzT3BlbjogYm9vbGVhbikge1xuICAgICAgaWYgKCF0aGlzLm5vZGVzLmhhc093blByb3BlcnR5KGtleSkpIHJldHVyblxuXG4gICAgICBjb25zdCBub2RlID0gdGhpcy5ub2Rlc1trZXldXG5cbiAgICAgIGlmIChub2RlLmNoaWxkcmVuICYmICFub2RlLmNoaWxkcmVuLmxlbmd0aCAmJiBub2RlLnZub2RlICYmICFub2RlLnZub2RlLmhhc0xvYWRlZCkge1xuICAgICAgICBub2RlLnZub2RlLmNoZWNrQ2hpbGRyZW4oKS50aGVuKCgpID0+IHRoaXMudXBkYXRlT3BlbihrZXksIGlzT3BlbikpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBub2RlLmlzT3BlbiA9IGlzT3BlblxuXG4gICAgICAgIG5vZGUuaXNPcGVuID8gdGhpcy5vcGVuQ2FjaGUuYWRkKGtleSkgOiB0aGlzLm9wZW5DYWNoZS5kZWxldGUoa2V5KVxuXG4gICAgICAgIHRoaXMudXBkYXRlVm5vZGVTdGF0ZShrZXkpXG4gICAgICB9XG4gICAgfSxcbiAgICB1cGRhdGVWbm9kZVN0YXRlIChrZXk6IHN0cmluZyB8IG51bWJlcikge1xuICAgICAgY29uc3Qgbm9kZSA9IHRoaXMubm9kZXNba2V5XVxuXG4gICAgICBpZiAobm9kZSAmJiBub2RlLnZub2RlKSB7XG4gICAgICAgIG5vZGUudm5vZGUuaXNTZWxlY3RlZCA9IG5vZGUuaXNTZWxlY3RlZFxuICAgICAgICBub2RlLnZub2RlLmlzSW5kZXRlcm1pbmF0ZSA9IG5vZGUuaXNJbmRldGVybWluYXRlXG4gICAgICAgIG5vZGUudm5vZGUuaXNBY3RpdmUgPSBub2RlLmlzQWN0aXZlXG4gICAgICAgIG5vZGUudm5vZGUuaXNPcGVuID0gbm9kZS5pc09wZW5cbiAgICAgIH1cbiAgICB9XG4gIH0sXG5cbiAgcmVuZGVyIChoKTogVk5vZGUge1xuICAgIGNvbnN0IGNoaWxkcmVuOiBWTm9kZUNoaWxkcmVuQXJyYXlDb250ZW50cyA9IHRoaXMuaXRlbXMubGVuZ3RoXG4gICAgICA/IHRoaXMuaXRlbXMubWFwKFZUcmVldmlld05vZGUub3B0aW9ucy5tZXRob2RzLmdlbkNoaWxkLmJpbmQodGhpcykpXG4gICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqL1xuICAgICAgOiB0aGlzLiRzbG90cy5kZWZhdWx0XG5cbiAgICByZXR1cm4gaCgnZGl2Jywge1xuICAgICAgc3RhdGljQ2xhc3M6ICd2LXRyZWV2aWV3JyxcbiAgICAgIGNsYXNzOiB7XG4gICAgICAgICd2LXRyZWV2aWV3LS1ob3ZlcmFibGUnOiB0aGlzLmhvdmVyYWJsZSxcbiAgICAgICAgLi4udGhpcy50aGVtZUNsYXNzZXNcbiAgICAgIH1cbiAgICB9LCBjaGlsZHJlbilcbiAgfVxufSlcbiJdfQ==