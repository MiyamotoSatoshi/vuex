// Styles
import '../../stylus/components/_range-sliders.styl';
// Extensions
import VSlider from '../VSlider';
import { createRange, deepEqual } from '../../util/helpers';
/* @vue/component */
export default {
    name: 'v-range-slider',
    extends: VSlider,
    props: {
        value: {
            type: Array,
            default: () => ([])
        }
    },
    data: vm => ({
        activeThumb: null,
        lazyValue: !vm.value.length
            ? [0, 0]
            : vm.value
    }),
    computed: {
        classes() {
            return Object.assign({}, {
                'v-input--range-slider': true
            }, VSlider.computed.classes.call(this));
        },
        internalValue: {
            get() {
                return this.lazyValue;
            },
            set(val) {
                const { min, max } = this;
                // Round value to ensure the
                // entire slider range can
                // be selected with step
                let value = val.map(v => this.roundValue(Math.min(Math.max(v, min), max)));
                // Switch values if range and wrong order
                if (value[0] > value[1] || value[1] < value[0]) {
                    if (this.activeThumb !== null)
                        this.activeThumb = this.activeThumb === 1 ? 0 : 1;
                    value = [value[1], value[0]];
                }
                this.lazyValue = value;
                if (!deepEqual(value, this.value))
                    this.$emit('input', value);
                this.validate();
            }
        },
        inputWidth() {
            return this.internalValue.map(v => (this.roundValue(v) - this.min) / (this.max - this.min) * 100);
        },
        isDirty() {
            return this.internalValue.some(v => v !== this.min) || this.alwaysDirty;
        },
        trackFillStyles() {
            const styles = VSlider.computed.trackFillStyles.call(this);
            const fillPercent = Math.abs(this.inputWidth[0] - this.inputWidth[1]);
            styles.width = `calc(${fillPercent}% - ${this.trackPadding}px)`;
            styles[this.$vuetify.rtl ? 'right' : 'left'] = `${this.inputWidth[0]}%`;
            return styles;
        },
        trackPadding() {
            if (this.isDirty ||
                this.internalValue[0])
                return 0;
            return VSlider.computed.trackPadding.call(this);
        }
    },
    methods: {
        getIndexOfClosestValue(arr, v) {
            if (Math.abs(arr[0] - v) < Math.abs(arr[1] - v))
                return 0;
            else
                return 1;
        },
        genInput() {
            return createRange(2).map(i => {
                const input = VSlider.methods.genInput.call(this);
                input.data.attrs.value = this.internalValue[i];
                input.data.on.focus = e => {
                    this.activeThumb = i;
                    VSlider.methods.onFocus.call(this, e);
                };
                return input;
            });
        },
        genChildren() {
            return [
                this.genInput(),
                this.genTrackContainer(),
                this.genSteps(),
                createRange(2).map(i => {
                    const value = this.internalValue[i];
                    const onDrag = e => {
                        this.isActive = true;
                        this.activeThumb = i;
                        this.onThumbMouseDown(e);
                    };
                    const valueWidth = this.inputWidth[i];
                    const isActive = (this.isFocused || this.isActive) && this.activeThumb === i;
                    return this.genThumbContainer(value, valueWidth, isActive, onDrag);
                })
            ];
        },
        onSliderClick(e) {
            if (!this.isActive) {
                this.isFocused = true;
                this.onMouseMove(e, true);
                this.$emit('change', this.internalValue);
            }
        },
        onMouseMove(e, trackClick = false) {
            const { value, isInsideTrack } = this.parseMouseMove(e);
            if (isInsideTrack) {
                if (trackClick)
                    this.activeThumb = this.getIndexOfClosestValue(this.internalValue, value);
                this.setInternalValue(value);
            }
        },
        onKeyDown(e) {
            const value = this.parseKeyDown(e, this.internalValue[this.activeThumb]);
            if (value == null)
                return;
            this.setInternalValue(value);
        },
        setInternalValue(value) {
            this.internalValue = this.internalValue.map((v, i) => {
                if (i === this.activeThumb)
                    return value;
                else
                    return Number(v);
            });
        }
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVlJhbmdlU2xpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbXBvbmVudHMvVlJhbmdlU2xpZGVyL1ZSYW5nZVNsaWRlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxTQUFTO0FBQ1QsT0FBTyw2Q0FBNkMsQ0FBQTtBQUVwRCxhQUFhO0FBQ2IsT0FBTyxPQUFPLE1BQU0sWUFBWSxDQUFBO0FBRWhDLE9BQU8sRUFDTCxXQUFXLEVBQ1gsU0FBUyxFQUNWLE1BQU0sb0JBQW9CLENBQUE7QUFFM0Isb0JBQW9CO0FBQ3BCLGVBQWU7SUFDYixJQUFJLEVBQUUsZ0JBQWdCO0lBRXRCLE9BQU8sRUFBRSxPQUFPO0lBRWhCLEtBQUssRUFBRTtRQUNMLEtBQUssRUFBRTtZQUNMLElBQUksRUFBRSxLQUFLO1lBQ1gsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDO1NBQ3BCO0tBQ0Y7SUFFRCxJQUFJLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ1gsV0FBVyxFQUFFLElBQUk7UUFDakIsU0FBUyxFQUFFLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxNQUFNO1lBQ3pCLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDUixDQUFDLENBQUMsRUFBRSxDQUFDLEtBQUs7S0FDYixDQUFDO0lBRUYsUUFBUSxFQUFFO1FBQ1IsT0FBTztZQUNMLE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUU7Z0JBQ3ZCLHVCQUF1QixFQUFFLElBQUk7YUFDOUIsRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQTtRQUN6QyxDQUFDO1FBQ0QsYUFBYSxFQUFFO1lBQ2IsR0FBRztnQkFDRCxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUE7WUFDdkIsQ0FBQztZQUNELEdBQUcsQ0FBRSxHQUFHO2dCQUNOLE1BQU0s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QUE7YUFDN0I7UUFDSCxDQUFDO1FBQ0QsU0FBUyxDQUFFLENBQUM7WUFDVixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFBO1lBRXhFLElBQUksS0FBSyxJQUFJLElBQUk7Z0JBQUUsT0FBTTtZQUV6QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUE7UUFDOUIsQ0FBQztRQUNELGdCQUFnQixDQUFFLEtBQUs7WUFDckIsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDbkQsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLFdBQVc7b0JBQUUsT0FBTyxLQUFLLENBQUE7O29CQUNuQyxPQUFPLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUN2QixDQUFDLENBQUMsQ0FBQTtRQUNKLENBQUM7S0FDRjtDQUNGLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBTdHlsZXNcbmltcG9ydCAnLi4vLi4vc3R5bHVzL2NvbXBvbmVudHMvX3JhbmdlLXNsaWRlcnMuc3R5bCdcblxuLy8gRXh0ZW5zaW9uc1xuaW1wb3J0IFZTbGlkZXIgZnJvbSAnLi4vVlNsaWRlcidcblxuaW1wb3J0IHtcbiAgY3JlYXRlUmFuZ2UsXG4gIGRlZXBFcXVhbFxufSBmcm9tICcuLi8uLi91dGlsL2hlbHBlcnMnXG5cbi8qIEB2dWUvY29tcG9uZW50ICovXG5leHBvcnQgZGVmYXVsdCB7XG4gIG5hbWU6ICd2LXJhbmdlLXNsaWRlcicsXG5cbiAgZXh0ZW5kczogVlNsaWRlcixcblxuICBwcm9wczoge1xuICAgIHZhbHVlOiB7XG4gICAgICB0eXBlOiBBcnJheSxcbiAgICAgIGRlZmF1bHQ6ICgpID0+IChbXSlcbiAgICB9XG4gIH0sXG5cbiAgZGF0YTogdm0gPT4gKHtcbiAgICBhY3RpdmVUaHVtYjogbnVsbCxcbiAgICBsYXp5VmFsdWU6ICF2bS52YWx1ZS5sZW5ndGhcbiAgICAgID8gWzAsIDBdXG4gICAgICA6IHZtLnZhbHVlXG4gIH0pLFxuXG4gIGNvbXB1dGVkOiB7XG4gICAgY2xhc3NlcyAoKSB7XG4gICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwge1xuICAgICAgICAndi1pbnB1dC0tcmFuZ2Utc2xpZGVyJzogdHJ1ZVxuICAgICAgfSwgVlNsaWRlci5jb21wdXRlZC5jbGFzc2VzLmNhbGwodGhpcykpXG4gICAgfSxcbiAgICBpbnRlcm5hbFZhbHVlOiB7XG4gICAgICBnZXQgKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5sYXp5VmFsdWVcbiAgICAgIH0sXG4gICAgICBzZXQgKHZhbCkge1xuICAgICAgICBjb25zdCB7IG1pbiwgbWF4IH0gPSB0aGlzXG4gICAgICAgIC8vIFJvdW5kIHZhbHVlIHRvIGVuc3VyZSB0aGVcbiAgICAgICAgLy8gZW50aXJlIHNsaWRlciByYW5nZSBjYW5cbiAgICAgICAgLy8gYmUgc2VsZWN0ZWQgd2l0aCBzdGVwXG4gICAgICAgIGxldCB2YWx1ZSA9IHZhbC5tYXAodiA9PiB0aGlzLnJvdW5kVmFsdWUoTWF0aC5taW4oTWF0aC5tYXgodiwgbWluKSwgbWF4KSkpXG5cbiAgICAgICAgLy8gU3dpdGNoIHZhbHVlcyBpZiByYW5nZSBhbmQgd3Jvbmcgb3JkZXJcbiAgICAgICAgaWYgKHZhbHVlWzBdID4gdmFsdWVbMV0gfHwgdmFsdWVbMV0gPCB2YWx1ZVswXSkge1xuICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZVRodW1iICE9PSBudWxsKSB0aGlzLmFjdGl2ZVRodW1iID0gdGhpcy5hY3RpdmVUaHVtYiA9PT0gMSA/IDAgOiAxXG4gICAgICAgICAgdmFsdWUgPSBbdmFsdWVbMV0sIHZhbHVlWzBdXVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5sYXp5VmFsdWUgPSB2YWx1ZVxuICAgICAgICBpZiAoIWRlZXBFcXVhbCh2YWx1ZSwgdGhpcy52YWx1ZSkpIHRoaXMuJGVtaXQoJ2lucHV0JywgdmFsdWUpXG5cbiAgICAgICAgdGhpcy52YWxpZGF0ZSgpXG4gICAgICB9XG4gICAgfSxcbiAgICBpbnB1dFdpZHRoICgpIHtcbiAgICAgIHJldHVybiB0aGlzLmludGVybmFsVmFsdWUubWFwKHYgPT4gKFxuICAgICAgICB0aGlzLnJvdW5kVmFsdWUodikgLSB0aGlzLm1pbikgLyAodGhpcy5tYXggLSB0aGlzLm1pbikgKiAxMDBcbiAgICAgIClcbiAgICB9LFxuICAgIGlzRGlydHkgKCkge1xuICAgICAgcmV0dXJuIHRoaXMuaW50ZXJuYWxWYWx1ZS5zb21lKHYgPT4gdiAhPT0gdGhpcy5taW4pIHx8IHRoaXMuYWx3YXlzRGlydHlcbiAgICB9LFxuICAgIHRyYWNrRmlsbFN0eWxlcyAoKSB7XG4gICAgICBjb25zdCBzdHlsZXMgPSBWU2xpZGVyLmNvbXB1dGVkLnRyYWNrRmlsbFN0eWxlcy5jYWxsKHRoaXMpXG4gICAgICBjb25zdCBmaWxsUGVyY2VudCA9IE1hdGguYWJzKHRoaXMuaW5wdXRXaWR0aFswXSAtIHRoaXMuaW5wdXRXaWR0aFsxXSlcblxuICAgICAgc3R5bGVzLndpZHRoID0gYGNhbGMoJHtmaWxsUGVyY2VudH0lIC0gJHt0aGlzLnRyYWNrUGFkZGluZ31weClgXG4gICAgICBzdHlsZXNbdGhpcy4kdnVldGlmeS5ydGwgPyAncmlnaHQnIDogJ2xlZnQnXSA9IGAke3RoaXMuaW5wdXRXaWR0aFswXX0lYFxuXG4gICAgICByZXR1cm4gc3R5bGVzXG4gICAgfSxcbiAgICB0cmFja1BhZGRpbmcgKCkge1xuICAgICAgaWYgKHRoaXMuaXNEaXJ0eSB8fFxuICAgICAgICB0aGlzLmludGVybmFsVmFsdWVbMF1cbiAgICAgICkgcmV0dXJuIDBcblxuICAgICAgcmV0dXJuIFZTbGlkZXIuY29tcHV0ZWQudHJhY2tQYWRkaW5nLmNhbGwodGhpcylcbiAgICB9XG4gIH0sXG5cbiAgbWV0aG9kczoge1xuICAgIGdldEluZGV4T2ZDbG9zZXN0VmFsdWUgKGFyciwgdikge1xuICAgICAgaWYgKE1hdGguYWJzKGFyclswXSAtIHYpIDwgTWF0aC5hYnMoYXJyWzFdIC0gdikpIHJldHVybiAwXG4gICAgICBlbHNlIHJldHVybiAxXG4gICAgfSxcbiAgICBnZW5JbnB1dCAoKSB7XG4gICAgICByZXR1cm4gY3JlYXRlUmFuZ2UoMikubWFwKGkgPT4ge1xuICAgICAgICBjb25zdCBpbnB1dCA9IFZTbGlkZXIubWV0aG9kcy5nZW5JbnB1dC5jYWxsKHRoaXMpXG5cbiAgICAgICAgaW5wdXQuZGF0YS5hdHRycy52YWx1ZSA9IHRoaXMuaW50ZXJuYWxWYWx1ZVtpXVxuXG4gICAgICAgIGlucHV0LmRhdGEub24uZm9jdXMgPSBlID0+IHtcbiAgICAgICAgICB0aGlzLmFjdGl2ZVRodW1iID0gaVxuICAgICAgICAgIFZTbGlkZXIubWV0aG9kcy5vbkZvY3VzLmNhbGwodGhpcywgZSlcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBpbnB1dFxuICAgICAgfSlcbiAgICB9LFxuICAgIGdlbkNoaWxkcmVuICgpIHtcbiAgICAgIHJldHVybiBbXG4gICAgICAgIHRoaXMuZ2VuSW5wdXQoKSxcbiAgICAgICAgdGhpcy5nZW5UcmFja0NvbnRhaW5lcigpLFxuICAgICAgICB0aGlzLmdlblN0ZXBzKCksXG4gICAgICAgIGNyZWF0ZVJhbmdlKDIpLm1hcChpID0+IHtcbiAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuaW50ZXJuYWxWYWx1ZVtpXVxuICAgICAgICAgIGNvbnN0IG9uRHJhZyA9IGUgPT4ge1xuICAgICAgICAgICAgdGhpcy5pc0FjdGl2ZSA9IHRydWVcbiAgICAgICAgICAgIHRoaXMuYWN0aXZlVGh1bWIgPSBpXG4gICAgICAgICAgICB0aGlzLm9uVGh1bWJNb3VzZURvd24oZSlcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3QgdmFsdWVXaWR0aCA9IHRoaXMuaW5wdXRXaWR0aFtpXVxuICAgICAgICAgIGNvbnN0IGlzQWN0aXZlID0gKHRoaXMuaXNGb2N1c2VkIHx8IHRoaXMuaXNBY3RpdmUpICYmIHRoaXMuYWN0aXZlVGh1bWIgPT09IGlcblxuICAgICAgICAgIHJldHVybiB0aGlzLmdlblRodW1iQ29udGFpbmVyKHZhbHVlLCB2YWx1ZVdpZHRoLCBpc0FjdGl2ZSwgb25EcmFnKVxuICAgICAgICB9KVxuICAgICAgXVxuICAgIH0sXG4gICAgb25TbGlkZXJDbGljayAoZSkge1xuICAgICAgaWYgKCF0aGlzLmlzQWN0aXZlKSB7XG4gICAgICAgIHRoaXMuaXNGb2N1c2VkID0gdHJ1ZVxuICAgICAgICB0aGlzLm9uTW91c2VNb3ZlKGUsIHRydWUpXG4gICAgICAgIHRoaXMuJGVtaXQoJ2NoYW5nZScsIHRoaXMuaW50ZXJuYWxWYWx1ZSlcbiAgICAgIH1cbiAgICB9LFxuICAgIG9uTW91c2VNb3ZlIChlLCB0cmFja0NsaWNrID0gZmFsc2UpIHtcbiAgICAgIGNvbnN0IHsgdmFsdWUsIGlzSW5zaWRlVHJhY2sgfSA9IHRoaXMucGFyc2VNb3VzZU1vdmUoZSlcblxuICAgICAgaWYgKGlzSW5zaWRlVHJhY2spIHtcbiAgICAgICAgaWYgKHRyYWNrQ2xpY2spIHRoaXMuYWN0aXZlVGh1bWIgPSB0aGlzLmdldEluZGV4T2ZDbG9zZXN0VmFsdWUodGhpcy5pbnRlcm5hbFZhbHVlLCB2YWx1ZSlcblxuICAgICAgICB0aGlzLnNldEludGVybmFsVmFsdWUodmFsdWUpXG4gICAgICB9XG4gICAgfSxcbiAgICBvbktleURvd24gKGUpIHtcbiAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5wYXJzZUtleURvd24oZSwgdGhpcy5pbnRlcm5hbFZhbHVlW3RoaXMuYWN0aXZlVGh1bWJdKVxuXG4gICAgICBpZiAodmFsdWUgPT0gbnVsbCkgcmV0dXJuXG5cbiAgICAgIHRoaXMuc2V0SW50ZXJuYWxWYWx1ZSh2YWx1ZSlcbiAgICB9LFxuICAgIHNldEludGVybmFsVmFsdWUgKHZhbHVlKSB7XG4gICAgICB0aGlzLmludGVybmFsVmFsdWUgPSB0aGlzLmludGVybmFsVmFsdWUubWFwKCh2LCBpKSA9PiB7XG4gICAgICAgIGlmIChpID09PSB0aGlzLmFjdGl2ZVRodW1iKSByZXR1cm4gdmFsdWVcbiAgICAgICAgZWxzZSByZXR1cm4gTnVtYmVyKHYpXG4gICAgICB9KVxuICAgIH1cbiAgfVxufVxuIl19