import { colorToInt, intToHex, colorToHex } from './colorUtils';
import * as sRGB from './color/transformSRGB';
import * as LAB from './color/transformCIELAB';
export function parse(theme, isItem = false) {
    const colors = Object.keys(theme);
    const parsedTheme = {};
    for (let i = 0; i < colors.length; ++i) {
        const name = colors[i];
        const value = theme[name];
        if (isItem) {
            if (name === 'base' || name.startsWith('lighten') || name.startsWith('darken')) {
                parsedTheme[name] = colorToHex(value);
            }
        }
        else if (typeof value === 'object') {
            parsedTheme[name] = parse(value, true);
        }
        else {
            parsedTheme[name] = genVariations(name, colorToInt(value));
        }
    }
    return parsedTheme;
}
/**
 * Generate the CSS for a base color (.primary)
 */
const genBaseColor = (name, value) => {
    return `
.${name} {
  background-color: ${value} !important;
  border-color: ${value} !important;
}
.${name}--text {
  color: ${value} !important;
  caret-color: ${value} !important;
}`;
};
/**
 * Generate the CSS for a variant color (.primary.darken-2)
 */
const genVariantColor = (name, variant, value) => {
    const [type, n] = variant.split(/(\d)/, 2);
    return `
.${name}.${type}-${n} {
  background-color: ${value} !important;
  border-color: ${value} !important;
}
.${name}--text.text--${type}-${n} {
  color: ${value} !important;
  caret-color: ${value} !important;
}`;
};
const genColorVariableName = (name, variant = 'base') => `--v-${name}-${variant}`;
const genColorVariable = (name, variant = 'base') => `var(${genColorVariableName(name, variant)})`;
export function genStyles(theme, cssVar = false) {
    const colors = Object.keys(theme);
    if (!colors.length)
        return '';
    let variablesCss = '';
    let css = '';
    const aColor = cssVar ? genColorVariable('primary') : theme.primary.base;
    css += `a { color: ${aColor}; }`;
    for (let i = 0; i < colors.length; ++i) {
        const name = colors[i];
        const value = theme[name];
        if (typeof value !== 'object')
            continue;
        css += genBaseColor(name, cssVar ? genColorVariable(name) : value.base);
        cssVar && (variablesCss += `  ${genColorVariableName(name)}: ${value.base};\n`);
        const variants = Object.keys(value);
        for (let i = 0; i < variants.length; ++i) {
            const variant = variants[i];
            const variantValue = value[variant];
            if (variant === 'base')
                continue;
            css += genVariantColor(name, variant, cssVar ? genColorVariable(name, variant) : variantValue);
            cssVar && (variablesCss += `  ${genColorVariableName(name, variant)}: ${variantValue};\n`);
        }
    }
    if (cssVar) {
        variablesCss = `:root {\n${variablesCss}}\n\n`;
    }
    return variablesCss + css;
}
export function genVariations(name, value) {
    const values = {
        base: intToHex(value)
    };
    for (let i = 5; i > 0; --i) {
        values[`lighten${i}`] = intToHex(lighten(value, i));
    }
    for (let i = 1; i <= 4; ++i) {
        values[`darken${i}`] = intToHex(darken(value, i));
    }
    return values;
}
function lighten(value, amount) {
    const lab = LAB.fromXYZ(sRGB.toXYZ(value));
    lab[0] = lab[0] + amount * 10;
    return sRGB.fromXYZ(LAB.toXYZ(lab));
}
function darken(value, amount) {
    const lab = LAB.fromXYZ(sRGB.toXYZ(value));
    lab[0] = lab[0] - amount * 10;
    return sRGB.fromXYZ(LAB.toXYZ(lab));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGhlbWUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXRpbC90aGVtZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQU8sTUFBTSxjQUFjLENBQUE7QUFDcEUsT0FBTyxLQUFLLElBQUksTUFBTSx1QkFBdUIsQ0FBQTtBQUM3QyxPQUFPLEtBQUssR0FBRyxNQUFNLHlCQUF5QixDQUFBO0FBc0I5QyxNQUFNLFVBQVUsS0FBSyxDQUFFLEtBQXFELEVBQUUsTUFBTSxHQUFHLEtBQUs7SUFDMUYsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUNqQyxNQUFNLFdBQVcsR0FBUSxFQUFFLENBQUE7SUFFM0IsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLEVBQUU7UUFDdEMsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ3RCLE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUV6QixJQUFJLE1BQU0sRUFBRTtZQUNWLElBQUksSUFBSSxLQUFLLE1BQU0sSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEVBQUU7Z0JBQzlFLFdBQVcsQ0FBQyxJQUFJLENBQUMsR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUE7YUFDdEM7U0FDRjthQUFNLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxFQUFFO1lBQ3BDLFdBQVcsQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFBO1NBQ3ZDO2FBQU07WUFDTCxXQUFXLENBQUMsSUFBSSxDQUFDLEdBQUcsYUFBYSxDQUFDLElB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Q0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTtJQUMxQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLE1BQU0sR0FBRyxFQUFFLENBQUE7SUFDN0IsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtBQUNyQyxDQUFDO0FBRUQsU0FBUyxNQUFNLENBQUUsS0FBVSxFQUFFLE1BQWM7SUFDekMsTUFBTSxHQUFHLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7SUFDMUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLEdBQUcsRUFBRSxDQUFBO0lBQzdCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7QUFDckMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNvbG9yVG9JbnQsIGludFRvSGV4LCBjb2xvclRvSGV4LCBSR0IgfSBmcm9tICcuL2NvbG9yVXRpbHMnXG5pbXBvcnQgKiBhcyBzUkdCIGZyb20gJy4vY29sb3IvdHJhbnNmb3JtU1JHQidcbmltcG9ydCAqIGFzIExBQiBmcm9tICcuL2NvbG9yL3RyYW5zZm9ybUNJRUxBQidcbmltcG9ydCB7IFZ1ZXRpZnlUaGVtZSB9IGZyb20gJ3R5cGVzJ1xuXG5pbnRlcmZhY2UgUGFyc2VkVGhlbWVJdGVtIHtcbiAgYmFzZTogc3RyaW5nXG4gIGxpZ2h0ZW41OiBzdHJpbmdcbiAgbGlnaHRlbjQ6IHN0cmluZ1xuICBsaWdodGVuMzogc3RyaW5nXG4gIGxpZ2h0ZW4yOiBzdHJpbmdcbiAgbGlnaHRlbjE6IHN0cmluZ1xuICBkYXJrZW4xOiBzdHJpbmdcbiAgZGFya2VuMjogc3RyaW5nXG4gIGRhcmtlbjM6IHN0cmluZ1xuICBkYXJrZW40OiBzdHJpbmdcblxuICBbbmFtZTogc3RyaW5nXTogc3RyaW5nXG59XG5cbmludGVyZmFjZSBQYXJzZWRUaGVtZSB7XG4gIFtuYW1lOiBzdHJpbmddOiBQYXJzZWRUaGVtZUl0ZW1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlICh0aGVtZTogVnVldGlmeVRoZW1lIHwgUmVjb3JkPHN0cmluZywgbnVtYmVyIHwgc3RyaW5nPiwgaXNJdGVtID0gZmFsc2UpOiBQYXJzZWRUaGVtZSB7XG4gIGNvbnN0IGNvbG9ycyA9IE9iamVjdC5rZXlzKHRoZW1lKVxuICBjb25zdCBwYXJzZWRUaGVtZTogYW55ID0ge31cblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGNvbG9ycy5sZW5ndGg7ICsraSkge1xuICAgIGNvbnN0IG5hbWUgPSBjb2xvcnNbaV1cbiAgICBjb25zdCB2YWx1ZSA9IHRoZW1lW25hbWVdXG5cbiAgICBpZiAoaXNJdGVtKSB7XG4gICAgICBpZiAobmFtZSA9PT0gJ2Jhc2UnIHx8IG5hbWUuc3RhcnRzV2l0aCgnbGlnaHRlbicpIHx8IG5hbWUuc3RhcnRzV2l0aCgnZGFya2VuJykpIHtcbiAgICAgICAgcGFyc2VkVGhlbWVbbmFtZV0gPSBjb2xvclRvSGV4KHZhbHVlKVxuICAgICAgfVxuICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0Jykge1xuICAgICAgcGFyc2VkVGhlbWVbbmFtZV0gPSBwYXJzZSh2YWx1ZSwgdHJ1ZSlcbiAgICB9IGVsc2Uge1xuICAgICAgcGFyc2VkVGhlbWVbbmFtZV0gPSBnZW5WYXJpYXRpb25zKG5hbWUsIGNvbG9yVG9JbnQodmFsdWUpKVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBwYXJzZWRUaGVtZVxufVxuXG4vKipcbiAqIEdlbmVyYXRlIHRoZSBDU1MgZm9yIGEgYmFzZSBjb2xvciAoLnByaW1hcnkpXG4gKi9cbmNvbnN0IGdlbkJhc2VDb2xvciA9IChuYW1lOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcpOiBzdHJpbmcgPT4ge1xuICByZXR1cm4gYFxuLiR7bmFtZX0ge1xuICBiYWNrZ3JvdW5kLWNvbG9yOiAke3ZhbHVlfSAhaW1wb3J0YW50O1xuICBib3JkZXItY29sb3I6ICR7dmFsdWV9ICFpbXBvcnRhbnQ7XG59XG4uJHtuYW1lfS0tdGV4dCB7XG4gIGNvbG9yOiAke3ZhbHVlfSAhaW1wb3J0YW50O1xuICBjYXJldC1jb2xvcjogJHt2YWx1ZX0gIWltcG9ydGFudDtcbn1gXG59XG5cbi8qKlxuICogR2VuZXJhdGUgdGhlIENTUyBmb3IgYSB2YXJpYW50IGNvbG9yICgucHJpbWFyeS5kYXJrZW4tMilcbiAqL1xuY29uc3QgZ2VuVmFyaWFudENvbG9yID0gKG5hbWU6IHN0cmluZywgdmFyaWFudDogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKTogc3RyaW5nID0+IHtcbiAgY29uc3QgW3R5cGUsIG5dID0gdmFyaWFudC5zcGxpdCgvKFxcZCkvLCAyKVxuICByZXR1cm4gYFxuLiR7bmFtZX0uJHt0eXBlfS0ke259IHtcbiAgYmFja2dyb3VuZC1jb2xvcjogJHt2YWx1ZX0gIWltcG9ydGFudDtcbiAgYm9yZGVyLWNvbG9yOiAke3ZhbHVlfSAhaW1wb3J0YW50O1xufVxuLiR7bmFtZX0tLXRleHQudGV4dC0tJHt0eXBlfS0ke259IHtcbiAgY29sb3I6ICR7dmFsdWV9ICFpbXBvcnRhbnQ7XG4gIGNhcmV0LWNvbG9yOiAke3ZhbHVlfSAhaW1wb3J0YW50O1xufWBcbn1cblxuY29uc3QgZ2VuQ29sb3JWYXJpYWJsZU5hbWUgPSAobmFtZTogc3RyaW5nLCB2YXJpYW50ID0gJ2Jhc2UnKTogc3RyaW5nID0+IGAtLXYtJHtuYW1lfS0ke3ZhcmlhbnR9YFxuXG5jb25zdCBnZW5Db2xvclZhcmlhYmxlID0gKG5hbWU6IHN0cmluZywgdmFyaWFudCA9ICdiYXNlJyk6IHN0cmluZyA9PiBgdmFyKCR7Z2VuQ29sb3JWYXJpYWJsZU5hbWUobmFtZSwgdmFyaWFudCl9KWBcblxuZXhwb3J0IGZ1bmN0aW9uIGdlblN0eWxlcyAodGhlbWU6IFBhcnNlZFRoZW1lLCBjc3NWYXIgPSBmYWxzZSk6IHN0cmluZyB7XG4gIGNvbnN0IGNvbG9ycyA9IE9iamVjdC5rZXlzKHRoZW1lKVxuXG4gIGlmICghY29sb3JzLmxlbmd0aCkgcmV0dXJuICcnXG5cbiAgbGV0IHZhcmlhYmxlc0NzcyA9ICcnXG4gIGxldCBjc3MgPSAnJ1xuXG4gIGNvbnN0IGFDb2xvciA9IGNzc1ZhciA/IGdlbkNvbG9yVmFyaWFibGUoJ3ByaW1hcnknKSA6IHRoZW1lLnByaW1hcnkuYmFzZVxuICBjc3MgKz0gYGEgeyBjb2xvcjogJHthQ29sb3J9OyB9YFxuXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgY29sb3JzLmxlbmd0aDsgKytpKSB7XG4gICAgY29uc3QgbmFtZSA9IGNvbG9yc1tpXVxuICAgIGNvbnN0IHZhbHVlID0gdGhlbWVbbmFtZV1cblxuICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICdvYmplY3QnKSBjb250aW51ZVxuXG4gICAgY3NzICs9IGdlbkJhc2VDb2xvcihuYW1lLCBjc3NWYXIgPyBnZW5Db2xvclZhcmlhYmxlKG5hbWUpIDogdmFsdWUuYmFzZSlcbiAgICBjc3NWYXIgJiYgKHZhcmlhYmxlc0NzcyArPSBgICAke2dlbkNvbG9yVmFyaWFibGVOYW1lKG5hbWUpfTogJHt2YWx1ZS5iYXNlfTtcXG5gKVxuXG4gICAgY29uc3QgdmFyaWFudHMgPSBPYmplY3Qua2V5cyh2YWx1ZSlcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhcmlhbnRzLmxlbmd0aDsgKytpKSB7XG4gICAgICBjb25zdCB2YXJpYW50ID0gdmFyaWFudHNbaV1cbiAgICAgIGNvbnN0IHZhcmlhbnRWYWx1ZSA9IHZhbHVlW3ZhcmlhbnRdXG4gICAgICBpZiAodmFyaWFudCA9PT0gJ2Jhc2UnKSBjb250aW51ZVxuXG4gICAgICBjc3MgKz0gZ2VuVmFyaWFudENvbG9yKG5hbWUsIHZhcmlhbnQsIGNzc1ZhciA/IGdlbkNvbG9yVmFyaWFibGUobmFtZSwgdmFyaWFudCkgOiB2YXJpYW50VmFsdWUpXG4gICAgICBjc3NWYXIgJiYgKHZhcmlhYmxlc0NzcyArPSBgICAke2dlbkNvbG9yVmFyaWFibGVOYW1lKG5hbWUsIHZhcmlhbnQpfTogJHt2YXJpYW50VmFsdWV9O1xcbmApXG4gICAgfVxuICB9XG5cbiAgaWYgKGNzc1Zhcikge1xuICAgIHZhcmlhYmxlc0NzcyA9IGA6cm9vdCB7XFxuJHt2YXJpYWJsZXNDc3N9fVxcblxcbmBcbiAgfVxuXG4gIHJldHVybiB2YXJpYWJsZXNDc3MgKyBjc3Ncbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdlblZhcmlhdGlvbnMgKG5hbWU6IHN0cmluZywgdmFsdWU6IFJHQik6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4ge1xuICBjb25zdCB2YWx1ZXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7XG4gICAgYmFzZTogaW50VG9IZXgodmFsdWUpXG4gIH1cblxuICBmb3IgKGxldCBpID0gNTsgaSA+IDA7IC0taSkge1xuICAgIHZhbHVlc1tgbGlnaHRlbiR7aX1gXSA9IGludFRvSGV4KGxpZ2h0ZW4odmFsdWUsIGkpKVxuICB9XG5cbiAgZm9yIChsZXQgaSA9IDE7IGkgPD0gNDsgKytpKSB7XG4gICAgdmFsdWVzW2BkYXJrZW4ke2l9YF0gPSBpbnRUb0hleChkYXJrZW4odmFsdWUsIGkpKVxuICB9XG5cbiAgcmV0dXJuIHZhbHVlc1xufVxuXG5mdW5jdGlvbiBsaWdodGVuICh2YWx1ZTogUkdCLCBhbW91bnQ6IG51bWJlcik6IFJHQiB7XG4gIGNvbnN0IGxhYiA9IExBQi5mcm9tWFlaKHNSR0IudG9YWVoodmFsdWUpKVxuICBsYWJbMF0gPSBsYWJbMF0gKyBhbW91bnQgKiAxMFxuICByZXR1cm4gc1JHQi5mcm9tWFlaKExBQi50b1hZWihsYWIpKVxufVxuXG5mdW5jdGlvbiBkYXJrZW4gKHZhbHVlOiBSR0IsIGFtb3VudDogbnVtYmVyKTogUkdCIHtcbiAgY29uc3QgbGFiID0gTEFCLmZyb21YWVooc1JHQi50b1hZWih2YWx1ZSkpXG4gIGxhYlswXSA9IGxhYlswXSAtIGFtb3VudCAqIDEwXG4gIHJldHVybiBzUkdCLmZyb21YWVooTEFCLnRvWFlaKGxhYikpXG59XG4iXX0=